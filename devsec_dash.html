<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevSec Dash - Local Security Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', 'SF Mono', Consolas, monospace;
            background: #0a0a0a;
            color: #e4e4e7;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #111111;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid #1f1f1f;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #1f1f1f;
            border: 1px solid #404040;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            color: #a1a1aa;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: #2a2a2a;
            border-color: #dc2626;
            color: #ffffff;
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }
        
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: #ffffff;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        h1::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 28px;
            background: #dc2626;
            margin-right: 12px;
            vertical-align: middle;
        }
        
        .subtitle {
            color: #a1a1aa;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 32px;
        }
        
        .input-section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #2d2d30;
            transition: all 0.2s ease;
        }
        
        .input-section:hover {
            border-color: #dc2626;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .upload-btn {
            background: #1f1f1f;
            color: #e4e4e7;
            border: 1px solid #404040;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-btn:hover {
            background: #2a2a2a;
            border-color: #dc2626;
            color: #ffffff;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px;
            font-family: 'SF Mono', Consolas, monospace;
            resize: vertical;
            background: #0f0f0f;
            color: #e4e4e7;
            font-size: 0.9rem;
        }
        
        textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
        }
        
        .scan-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            transition: all 0.2s ease;
        }
        
        .scan-btn:hover {
            background: #b91c1c;
        }
        
        .scan-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
                filter: blur(5px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0);
            }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #2d2d30;
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            border-color: #404040;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #ffffff;
        }
        
        .metric-label {
            color: #a1a1aa;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .score-high { color: #10b981; }
        .score-medium { color: #f59e0b; }
        .score-low { color: #dc2626; }
        
        .chart-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2d2d30;
        }
        
        .findings {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2d2d30;
        }
        
        .findings h3 {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .finding {
            border-left: 3px solid;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 6px 6px 0;
            transition: all 0.2s ease;
            background: #0f0f0f;
        }
        
        .finding:hover {
            background: #1f1f1f;
        }
        
        .finding.high {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
        }
        
        .finding.high:hover {
            background: rgba(220, 38, 38, 0.1);
        }
        
        .finding.medium {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }
        
        .finding.medium:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        .finding.low {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.05);
        }
        
        .finding.low:hover {
            background: rgba(107, 114, 128, 0.1);
        }
        
        .finding-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 0.95rem;
        }
        
        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .finding-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .finding-line-number {
            background: #2a2a2a;
            color: #a1a1aa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'SF Mono', Consolas, monospace;
            border: 1px solid #404040;
        }
        
        .finding-description {
            color: #a1a1aa;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .finding-code {
            background: #0a0a0a;
            border: 1px solid #404040;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .finding-code-header {
            background: #1a1a1a;
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
            font-size: 0.8rem;
            color: #a1a1aa;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .finding-code pre {
            margin: 0;
            padding: 12px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.85rem;
            color: #e4e4e7;
            overflow-x: auto;
            line-height: 1.4;
        }
        
        .finding-code code {
            color: #e4e4e7;
        }
        
        .export-btn {
            background: #1f1f1f;
            color: #e4e4e7;
            border: 1px solid #404040;
            padding: 8px 16px;
            border-radius: 6px;
            margin: 4px 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .export-btn:hover {
            background: #2a2a2a;
            border-color: #dc2626;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #a1a1aa;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid transparent;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            background: conic-gradient(from 0deg, #667eea, #764ba2, #f093fb, #667eea);
            mask: radial-gradient(farthest-side, transparent calc(100% - 3px), white calc(100% - 3px));
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .scan-type-badge {
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .finding-tool-tag {
            background: #dc2626;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .finding-tool-tag:first-child {
            margin-right: 4px;
        }
        
        .progress-container {
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2d2d30;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #2d2d30;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc2626, #f59e0b, #10b981);
            width: 0%;
            transition: width 0.3s ease-in-out;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #a1a1aa;
            font-family: 'SF Mono', Consolas, monospace;
        }
        
        .scan-mode-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 6px;
            background: #1a1a1a;
            border: 1px solid #2d2d30;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #a1a1aa;
            font-size: 0.9rem;
        }
        
        .tab-btn.active {
            background: #dc2626;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: #2a2a2a;
            color: #ffffff;
        }
        
        .scan-mode {
            min-height: 200px;
        }
        
        .project-summary {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2d2d30;
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #2d2d30;
            border-radius: 6px;
            background: #0f0f0f;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #2d2d30;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .file-item:hover {
            background: #1a1a1a;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-name {
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.85rem;
            color: #e4e4e7;
        }
        
        .file-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .severity-badge {
            background: #2a2a2a;
            color: #a1a1aa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            min-width: 18px;
            text-align: center;
            border: 1px solid #404040;
        }
        
        .severity-badge.high { background: rgba(220, 38, 38, 0.2); color: #dc2626; border-color: #dc2626; }
        .severity-badge.medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border-color: #f59e0b; }
        .severity-badge.low { background: rgba(107, 114, 128, 0.2); color: #6b7280; border-color: #6b7280; }
        
        .file-item.selected {
            background: rgba(220, 38, 38, 0.1);
            border-left: 3px solid #dc2626;
        }
        
        .sidebar {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #2d2d30;
            min-height: 400px;
        }
        
        .sidebar h4 {
            color: #ffffff;
            font-size: 0.95rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .findings-section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2d2d30;
        }
        
        .debug-console {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            height: 300px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            z-index: 1000;
            transition: bottom 0.3s ease;
            overflow: hidden;
            border-top: 2px solid #4a5568;
        }
        
        .debug-console.open {
            bottom: 0;
        }
        
        .debug-header {
            background: #2d3748;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4a5568;
        }
        
        .debug-content {
            height: 250px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .debug-log {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .debug-log.info { color: #63b3ed; }
        .debug-log.warn { color: #f6ad55; }
        .debug-log.error { color: #fc8181; }
        .debug-log.success { color: #68d391; }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 20px;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .debug-toggle:hover {
            background: #2d3748;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="settings-btn" onclick="openSettings()"><i data-lucide="settings"></i></button>
            <h1>DevSec Dash</h1>
            <p class="subtitle">Local Security Scanner - Quick Regex + Deep AST Analysis - Your code never leaves your browser</p>
        </header>
        
        <div class="input-section">
            <div class="scan-mode-tabs">
                <button class="tab-btn active" onclick="switchMode('single')" id="singleTab">
                    <i data-lucide="file-text"></i> Single File
                </button>
                <button class="tab-btn" onclick="switchMode('project')" id="projectTab">
                    <i data-lucide="folder"></i> Project Folder
                </button>
            </div>
            
            <!-- Single File Mode -->
            <div class="scan-mode" id="singleMode">
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".py,.js,.php,.java,.rb,.go,.cpp,.c,.cs" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i data-lucide="upload"></i> Upload Code File
                    </button>
                    <p>or paste your code below:</p>
                    <textarea id="codeInput" placeholder="Paste your source code here..."></textarea>
                </div>
            </div>
            
            <!-- Project Mode -->
            <div class="scan-mode" id="projectMode" style="display: none;">
                <div class="file-upload">
                    <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('folderInput').click()">
                        <i data-lucide="folder-open"></i> Select Project Folder
                    </button>
                    <div id="folderStatus" style="margin: 15px 0; text-align: center; color: #718096;"></div>
                    <div style="margin-top: 10px; padding: 12px; background: #262626; border-radius: 6px; font-size: 0.8rem; color: #a1a1aa; border: 1px solid #404040;">
                        <strong><i data-lucide="shield-x" style="width: 14px; height: 14px; display: inline;"></i> Auto-ignored:</strong> .venv/, venv/, node_modules/, __pycache__/, .git/, build/, dist/, .vscode/, .idea/ and other common directories
                        <br><small style="opacity: 0.7;">This helps focus scanning on your actual source code</small>
                    </div>
                </div>
            </div>
            
            <div style="margin: 15px 0; text-align: center;">
                <label style="margin-right: 30px; display: inline-flex; align-items: center; gap: 8px; color: #e4e4e7;">
                    <input type="radio" name="scanType" value="deep" checked> 
                    <i data-lucide="microscope" style="width: 18px; height: 18px;"></i> 
                    <div>
                        <strong>AST Analysis</strong>
                        <div style="font-size: 0.8rem; color: #a1a1aa;">Python Pyodide scanner</div>
                    </div>
                </label>
                <label style="display: inline-flex; align-items: center; gap: 8px; color: #e4e4e7;">
                    <input type="radio" name="scanType" value="professional" id="professionalScan"> 
                    <i data-lucide="shield-check" style="width: 18px; height: 18px;"></i>
                    <div>
                        <strong>Professional Scan</strong>
                        <div style="font-size: 0.8rem; color: #a1a1aa;">Bandit + Semgrep backend</div>
                    </div>
                </label>
            </div>
            
            <div id="serverStatus" style="text-align: center; margin: 10px 0; font-size: 0.9rem;"></div>
            
            <button class="scan-btn" id="scanBtn" onclick="scanCode()">
                <i data-lucide="scan" style="width: 18px; height: 18px; margin-right: 8px;"></i> Scan for Vulnerabilities
            </button>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing your code...</p>
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
        
        <!-- Single File Results -->
        <div class="results" id="singleResults" style="display: none;">
            <div class="dashboard">
                <div class="metric-card">
                    <div class="metric-value" id="securityScore">0</div>
                    <div class="metric-label">Security Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="issueCount">0</div>
                    <div class="metric-label">Issues Found</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="vulnerabilityChart"></canvas>
            </div>
            
            <div class="findings">
                <h3><i data-lucide="search"></i> Security Findings <span id="scanTypeBadge" class="scan-type-badge"></span></h3>
                <div style="margin: 15px 0;">
                    <button class="export-btn" onclick="exportReport('json')"><i data-lucide="file-json"></i> Export JSON</button>
                    <button class="export-btn" onclick="exportReport('markdown')"><i data-lucide="file-text"></i> Export Markdown</button>
                    <button class="export-btn" onclick="exportReport('pdf')"><i data-lucide="file"></i> Export PDF</button>
                </div>
                <div id="findingsList"></div>
            </div>
        </div>
        
        <!-- Project Results -->
        <div class="results" id="projectResults" style="display: none;">
            <div class="project-summary">
                <div class="dashboard">
                    <div class="metric-card">
                        <div class="metric-value" id="projectScore">0</div>
                        <div class="metric-label">Project Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="projectFiles">0</div>
                        <div class="metric-label">Files Scanned</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="projectIssues">0</div>
                        <div class="metric-label">Total Issues</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="projectLines">0</div>
                        <div class="metric-label">Lines of Code</div>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="sidebar">
                    <h4><i data-lucide="folder"></i> Project Files</h4>
                    <div class="file-list" id="fileList"></div>
                </div>
                
                <div class="findings-section">
                    <h3><i data-lucide="file-search"></i> File Details <span id="selectedFileName" style="font-family: monospace; color: #dc2626;"></span></h3>
                    <div style="margin: 15px 0;">
                        <button class="export-btn" onclick="exportReport('json')"><i data-lucide="file-json"></i> Export JSON</button>
                        <button class="export-btn" onclick="exportReport('markdown')"><i data-lucide="file-text"></i> Export Markdown</button>
                        <button class="export-btn" onclick="exportReport('pdf')"><i data-lucide="file"></i> Export PDF</button>
                    </div>
                    <div id="selectedFileFindings">
                        <p style="text-align: center; color: #718096; margin: 40px 0;">
                            Select a file from the sidebar to view its security findings
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Console -->
    <div class="debug-console" id="debugConsole">
        <div class="debug-header">
            <span><i data-lucide="bug"></i> Debug Console</span>
            <div>
                <button onclick="clearDebugLog()" style="background: none; border: none; color: #e2e8f0; cursor: pointer; margin-right: 10px;">Clear</button>
                <button onclick="toggleDebugConsole()" style="background: none; border: none; color: #e2e8f0; cursor: pointer;">×</button>
            </div>
        </div>
        <div class="debug-content" id="debugContent"></div>
    </div>
    
    <!-- Debug Toggle Button -->
    <button class="debug-toggle" id="debugToggle" onclick="toggleDebugConsole()"><i data-lucide="bug"></i></button>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3><i data-lucide="settings"></i> Settings</h3>
                <button class="close-btn" onclick="closeSettings()">✕</button>
            </div>
            
            <div class="setting-item">
                <label>Default Scan Type:</label>
                <select id="defaultScanType">
                    <option value="deep">AST Analysis (Pyodide)</option>
                    <option value="professional">Professional (Bandit + Semgrep)</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label>Auto-clear results:</label>
                <input type="checkbox" id="autoClearResults">
            </div>
            
            <div class="setting-item">
                <label>Show progress for files ></label>
                <input type="number" id="progressThreshold" min="10" max="1000" value="50" style="width: 80px;"> lines
            </div>
            
            <div class="setting-item">
                <label>Include low severity findings:</label>
                <input type="checkbox" id="includeLowSeverity" checked>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="upload-btn" onclick="saveSettings()" style="background: #10b981;"><i data-lucide="save"></i> Save Settings</button>
                <button class="upload-btn" onclick="resetSettings()" style="background: #dc2626; margin-left: 10px;"><i data-lucide="rotate-ccw"></i> Reset</button>
            </div>
        </div>
    </div>

    <script>
        let scanResults = {};
        let projectResults = {};
        let chart = null;
        let pyodide = null;
        let serverAvailable = false;
        let currentMode = 'single';
        let selectedFile = null;
        const API_BASE = 'http://localhost:8080';
        let debugLogs = [];
        
        // Debug logging functions
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLogs.push(logEntry);
            
            // Keep only last 100 logs
            if (debugLogs.length > 100) {
                debugLogs = debugLogs.slice(-100);
            }
            
            updateDebugConsole();
            
            // Also log to browser console
            const consoleMethod = type === 'error' ? 'error' : type === 'warn' ? 'warn' : 'log';
            console[consoleMethod](`[${timestamp}] ${message}`);
        }
        
        function updateDebugConsole() {
            const content = document.getElementById('debugContent');
            if (!content) return;
            
            content.innerHTML = debugLogs.map(log => 
                `<div class="debug-log ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            
            // Auto scroll to bottom
            content.scrollTop = content.scrollHeight;
        }
        
        function toggleDebugConsole() {
            const console = document.getElementById('debugConsole');
            console.classList.toggle('open');
        }
        
        function clearDebugLog() {
            debugLogs = [];
            updateDebugConsole();
        }
        
        // Initialize Pyodide
        async function initPyodide() {
            if (!pyodide) {
                debugLog('Initializing Pyodide environment...', 'info');
                pyodide = await loadPyodide();
                debugLog('Pyodide loaded successfully', 'success');
                await pyodide.runPython(`
import ast
import re
from typing import List, Dict, Any

class SecurityScanner:
    def __init__(self):
        self.findings = []
    
    def scan_code(self, code: str) -> Dict[str, Any]:
        self.findings = []
        
        try:
            tree = ast.parse(code)
            self.visit_node(tree)
        except SyntaxError as e:
            self.findings.append({
                'category': 'syntax',
                'name': 'Syntax Error',
                'severity': 'high',
                'line': e.lineno or 1,
                'code': str(e),
                'description': 'Fix syntax errors before security analysis'
            })
        
        return {
            'findings': self.findings,
            'total_lines': len(code.split('\\n'))
        }
    
    def visit_node(self, node, line_offset=0):
        for child in ast.walk(node):
            self.check_hardcoded_secrets(child)
            self.check_dangerous_functions(child)
            self.check_weak_crypto(child)
            self.check_sql_patterns(child)
            self.check_subprocess_usage(child)
            self.check_imports(child)
            self.check_file_operations(child)
            self.check_vulnerable_dependencies(child)
    
    def check_hardcoded_secrets(self, node):
        if isinstance(node, ast.Assign):
            for target in node.targets:
                if isinstance(target, ast.Name):
                    var_name = target.id.lower()
                    if isinstance(node.value, ast.Constant) and isinstance(node.value.value, str):
                        value = node.value.value
                        
                        if any(secret in var_name for secret in ['password', 'pass', 'pwd']):
                            self.add_finding('secrets', 'Hardcoded Password', 'high', node, f"{target.id} = '{value}'")
                        elif any(key in var_name for key in ['api_key', 'apikey', 'secret']):
                            self.add_finding('secrets', 'Secret/API Key', 'high', node, f"{target.id} = '{value}'")
    
    def check_dangerous_functions(self, node):
        if isinstance(node, ast.Call):
            if isinstance(node.func, ast.Name):
                func_name = node.func.id
                if func_name == 'eval':
                    self.add_finding('injection', 'Code Injection (eval)', 'high', node, 'eval() call detected')
                elif func_name == 'exec':
                    self.add_finding('injection', 'Code Execution (exec)', 'high', node, 'exec() call detected')
            elif isinstance(node.func, ast.Attribute):
                if node.func.attr == 'execute' and len(node.args) > 0:
                    self.add_finding('injection', 'SQL Execution Risk', 'medium', node, 'Database execute() call')
    
    def check_weak_crypto(self, node):
        if isinstance(node, ast.Call):
            if isinstance(node.func, ast.Attribute):
                if hasattr(node.func.value, 'id') and node.func.value.id == 'hashlib':
                    if node.func.attr in ['md5', 'sha1']:
                        # Check if this is actually being used for security (not just checksums/etc)
                        self.add_finding('crypto', f'Weak Hash Algorithm ({node.func.attr.upper()})', 'medium', node, f'hashlib.{node.func.attr}() usage')
    
    def check_sql_patterns(self, node):
        if isinstance(node, ast.BinOp) and isinstance(node.op, ast.Add):
            if self.is_string_concat_with_var(node):
                self.add_finding('injection', 'String Concatenation Risk', 'medium', node, 'Potential SQL injection via string concatenation')
    
    def is_string_concat_with_var(self, node):
        def has_string_and_var(n):
            if isinstance(n, ast.Constant) and isinstance(n.value, str):
                return True, False
            elif isinstance(n, ast.Name):
                return False, True
            elif isinstance(n, ast.BinOp) and isinstance(n.op, ast.Add):
                left_str, left_var = has_string_and_var(n.left)
                right_str, right_var = has_string_and_var(n.right)
                return left_str or right_str, left_var or right_var
            return False, False
        
        has_str, has_var = has_string_and_var(node)
        return has_str and has_var
    
    def add_finding(self, category, name, severity, node, code_snippet):
        self.findings.append({
            'category': category,
            'name': name,
            'severity': severity,
            'line': getattr(node, 'lineno', 1),
            'code': code_snippet,
            'description': self.get_description(name)
        })
    
    def check_subprocess_usage(self, node):
        if isinstance(node, ast.Call):
            if isinstance(node.func, ast.Attribute):
                if (hasattr(node.func.value, 'id') and 
                    node.func.value.id == 'subprocess' and 
                    node.func.attr in ['call', 'run', 'Popen']):
                    # Check for shell=True
                    for keyword in node.keywords:
                        if keyword.arg == 'shell' and isinstance(keyword.value, ast.Constant) and keyword.value.value:
                            self.add_finding('injection', 'Command Injection Risk', 'high', node, f'subprocess.{node.func.attr}() with shell=True')
    
    def check_imports(self, node):
        if isinstance(node, ast.Import):
            for alias in node.names:
                if alias.name in ['pickle', 'cPickle']:
                    self.add_finding('deserialization', 'Unsafe Deserialization', 'medium', node, f'import {alias.name}')
        elif isinstance(node, ast.ImportFrom):
            if node.module in ['pickle', 'cPickle']:
                self.add_finding('deserialization', 'Unsafe Deserialization', 'medium', node, f'from {node.module} import ...')
    
    def check_file_operations(self, node):
        if isinstance(node, ast.Call):
            if isinstance(node.func, ast.Name) and node.func.id == 'open':
                if len(node.args) > 1:
                    # Check for write modes
                    if isinstance(node.args[1], ast.Constant):
                        mode = node.args[1].value
                        if 'w' in mode or 'a' in mode:
                            self.add_finding('file_access', 'File Write Operation', 'low', node, f'open() with write mode: {mode}')
            elif isinstance(node.func, ast.Attribute):
                if (hasattr(node.func.value, 'id') and 
                    node.func.value.id == 'os' and 
                    node.func.attr in ['system', 'popen']):
                    self.add_finding('injection', 'OS Command Execution', 'high', node, f'os.{node.func.attr}() call')
    
    def check_vulnerable_dependencies(self, node):
        # Only flag truly risky packages, not common utilities
        vulnerable_packages = {
            'yaml': ('YAML loading can execute arbitrary code - use yaml.safe_load()', 'high'),
            'pickle': ('Arbitrary code execution during deserialization', 'high'),
            'jsonpickle': ('JSON + pickle combination risks', 'medium'),
            'shelve': ('Uses pickle internally - deserialization risk', 'medium')
        }
        
        if isinstance(node, ast.Import):
            for alias in node.names:
                package_name = alias.name.split('.')[0]  # Get root package
                if package_name in vulnerable_packages:
                    desc, severity = vulnerable_packages[package_name]
                    self.add_finding('dependencies', f'Potentially Unsafe Package: {package_name}', severity, node, f'import {alias.name}')
        elif isinstance(node, ast.ImportFrom):
            if node.module:
                package_name = node.module.split('.')[0]
                if package_name in vulnerable_packages:
                    desc, severity = vulnerable_packages[package_name]
                    self.add_finding('dependencies', f'Potentially Unsafe Package: {package_name}', severity, node, f'from {node.module} import ...')
    
    def get_description(self, name):
        descriptions = {
            'Hardcoded Password': 'Store passwords in environment variables or secure vaults',
            'Secret/API Key': 'Externalize secrets using environment variables or key management',
            'Code Injection (eval)': 'Never use eval() with user input - use safer alternatives',
            'Code Execution (exec)': 'Avoid exec() with untrusted input - use safer alternatives',
            'SQL Execution Risk': 'Use parameterized queries to prevent SQL injection',
            'Weak Hash Algorithm': 'Use SHA-256 or stronger hashing algorithms',
            'String Concatenation Risk': 'Use parameterized queries instead of string concatenation',
            'Command Injection Risk': 'Avoid shell=True in subprocess calls - use array arguments',
            'OS Command Execution': 'Use subprocess module instead of os.system/popen',
            'Unsafe Deserialization': 'Avoid pickle with untrusted data - use safer serialization',
            'File Write Operation': 'Ensure file paths are validated and sanitized',
            'Potentially Unsafe Package: yaml': 'Use yaml.safe_load() instead of yaml.load() to prevent code execution',
            'Potentially Unsafe Package: pickle': 'Never unpickle untrusted data - use JSON instead',
            'Potentially Unsafe Package: shelve': 'Be aware of pickle-based security risks with untrusted data',
            'Potentially Unsafe Package: jsonpickle': 'Avoid with untrusted data - use pure JSON instead',
            'Weak Hash Algorithm (MD5)': 'MD5 is cryptographically broken - use SHA-256 or stronger',
            'Weak Hash Algorithm (SHA1)': 'SHA-1 has known collision vulnerabilities - use SHA-256 or stronger',
            'Weak Encryption (DES)': 'DES has a small key size and is easily broken - use AES-256',
            'Weak Encryption (RC4)': 'RC4 has known vulnerabilities - use AES or ChaCha20'
        }
        return descriptions.get(name, 'Security issue detected')

scanner = SecurityScanner()
                `);
            }
            return pyodide;
        }
        
        // Security patterns - much more precise to avoid false positives
        const securityRules = {
            secrets: [
                { pattern: /(?:password|pwd|pass)\s*[=:]\s*["'](?!.*(?:placeholder|example|test|demo|xxx|\*+|_+))[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{}|;:,.<>?]{4,}["']/gi, name: "Hardcoded Password", severity: "high" },
                { pattern: /(?:api[_-]?key|apikey)\s*[=:]\s*["'](?!.*(?:your|key|here|placeholder|example|test|demo|xxx|\*+|_+))[a-zA-Z0-9_-]{10,}["']/gi, name: "API Key Exposure", severity: "high" },
                { pattern: /(?:secret[_-]?key|secretkey)\s*[=:]\s*["'](?!.*(?:your|secret|here|placeholder|example|test|demo|xxx|\*+|_+))[a-zA-Z0-9!@#$%^&*()_+\-=]{8,}["']/gi, name: "Secret Key", severity: "high" },
                { pattern: /(?:(?:access_token|bearer_token|auth_token)\s*[=:]\s*["'](?!.*(?:token|placeholder|example|test|demo|xxx|\*+|_+))[a-zA-Z0-9._-]{20,}["'])/gi, name: "Token Exposure", severity: "medium" },
                { pattern: /-----BEGIN\s+(?:RSA\s+)?PRIVATE\s+KEY-----/g, name: "Private Key", severity: "high" }
            ],
            injection: [
                { pattern: /["'][^"']*["']\s*\+\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*\+\s*["'][^"']*["']/g, name: "SQL Injection Risk", severity: "high" },
                { pattern: /(?:execute|query)\s*\(\s*["'][^"']*["']\s*\+\s*[a-zA-Z_$]/gi, name: "Dynamic SQL Execution", severity: "high" },
                { pattern: /innerHTML\s*[=]\s*[a-zA-Z_$][a-zA-Z0-9_$]*(?:\s*\+|\s*\+=)/g, name: "XSS Risk (innerHTML)", severity: "medium" },
                { pattern: /document\.write\s*\(\s*[a-zA-Z_$]/g, name: "XSS Risk (document.write)", severity: "medium" },
                { pattern: /\beval\s*\(\s*[a-zA-Z_$]/g, name: "Code Injection (eval)", severity: "high" }
            ],
            crypto: [
                { pattern: /\b(?:MD5|md5)\s*\(/g, name: "Weak Hash Algorithm (MD5)", severity: "medium" },
                { pattern: /\bsha1\s*\(/gi, name: "Weak Hash Algorithm (SHA1)", severity: "medium" },
                { pattern: /\b(?:DES|TripleDES)\s*[\(\.]|Cipher\.getInstance\s*\(["']DES/gi, name: "Weak Encryption (DES)", severity: "high" },
                { pattern: /\bRC4\b|Cipher\.getInstance\s*\(["']RC4/gi, name: "Weak Encryption (RC4)", severity: "high" },
                { pattern: /Math\.random\s*\(\s*\)(?!.*(?:\/\/.*(?:demo|test|example)|seed|salt))/g, name: "Weak Random Generator", severity: "low" }
            ],
            paths: [
                { pattern: /["'][^"']*\.\.[\/\\][^"']*/g, name: "Path Traversal Risk", severity: "medium" },
                { pattern: /["'][\/\\]tmp[\/\\][^"']*/g, name: "Temp Directory Usage", severity: "low" }
            ],
            subprocess: [
                { pattern: /subprocess\.(call|run|Popen)\s*\([^)]*shell\s*=\s*True/gi, name: "Command Injection Risk", severity: "high" },
                { pattern: /os\.system\s*\(/g, name: "OS Command Execution", severity: "high" },
                { pattern: /os\.popen\s*\(/g, name: "OS Command Execution", severity: "high" }
            ]
        };
        
        // File upload handlers
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('codeInput').value = e.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // Directories and files to ignore during scanning
        const IGNORE_PATTERNS = [
            // Virtual environments
            '.venv/', 'venv/', '.virtualenv/', 'virtualenv/', 'env/', '.env/',
            // Node.js
            'node_modules/', '.npm/', '.yarn/',
            // Python
            '__pycache__/', '.pytest_cache/', '.mypy_cache/', '.tox/', 'build/', 'dist/', '*.egg-info/',
            // Git and version control
            '.git/', '.svn/', '.hg/', '.bzr/',
            // IDEs and editors
            '.vscode/', '.idea/', '.vs/', '*.swp', '*.swo', '*~',
            // OS files
            '.DS_Store', 'Thumbs.db', 'desktop.ini',
            // Logs and temp files
            'logs/', 'log/', '*.log', 'tmp/', 'temp/',
            // Build outputs
            'target/', 'out/', 'bin/', 'obj/', 'build/',
            // Package managers
            'vendor/', 'packages/', '.nuget/',
            // Other common ignores
            'coverage/', '.coverage/', '.nyc_output/', 'htmlcov/'
        ];

        function shouldIgnoreFile(filePath) {
            const normalizedPath = filePath.replace(/\\/g, '/');
            
            return IGNORE_PATTERNS.some(pattern => {
                if (pattern.endsWith('/')) {
                    // Directory pattern
                    return normalizedPath.includes('/' + pattern) || normalizedPath.startsWith(pattern);
                } else if (pattern.includes('*')) {
                    // Wildcard pattern
                    const regex = new RegExp(pattern.replace(/\*/g, '.*'));
                    return regex.test(normalizedPath);
                } else {
                    // Exact match or file pattern
                    return normalizedPath.includes(pattern) || normalizedPath.endsWith('/' + pattern);
                }
            });
        }

        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            // Filter out ignored directories/files first
            const filteredFiles = files.filter(f => !shouldIgnoreFile(f.webkitRelativePath || f.name));
            
            // Then filter for code files
            const codeFiles = filteredFiles.filter(f => 
                f.name.endsWith('.py') || f.name.endsWith('.js') || f.name.endsWith('.php') ||
                f.name.endsWith('.java') || f.name.endsWith('.rb') || f.name.endsWith('.go') ||
                f.name.endsWith('.cpp') || f.name.endsWith('.c') || f.name.endsWith('.cs')
            );
            
            const ignoredCount = files.length - filteredFiles.length;
            
            debugLog(`Folder selected: ${files.length} total files`, 'info');
            debugLog(`Ignored ${ignoredCount} files/directories (${IGNORE_PATTERNS.slice(0, 5).join(', ')}...)`, 'info');
            debugLog(`Found ${codeFiles.length} code files after filtering`, 'info');
            if (codeFiles.length <= 10) {
                debugLog(`Code files: ${codeFiles.map(f => f.name).join(', ')}`, 'info');
            } else {
                debugLog(`Code files: ${codeFiles.slice(0, 10).map(f => f.name).join(', ')} and ${codeFiles.length - 10} more...`, 'info');
            }
            
            document.getElementById('folderStatus').innerHTML = 
                `✅ Selected ${codeFiles.length} code files from ${files.length} total files` + 
                (ignoredCount > 0 ? ` (${ignoredCount} ignored)` : '');
        });
        
        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'Tab').classList.add('active');
            
            // Show/hide mode sections
            document.getElementById('singleMode').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('projectMode').style.display = mode === 'project' ? 'block' : 'none';
            
            // Hide results
            document.getElementById('singleResults').style.display = 'none';
            document.getElementById('projectResults').style.display = 'none';
        }
        
        async function scanCode() {
            if (currentMode === 'project') {
                return scanProject();
            }
            
            const code = document.getElementById('codeInput').value.trim();
            if (!code) {
                alert('Please upload a file or paste some code first!');
                return;
            }
            
            const settings = getSettings();
            const scanType = document.querySelector('input[name="scanType"]:checked').value;
            
            debugLog(`Starting ${scanType} scan for single file`, 'info');
            
            if (settings.autoClearResults) {
                document.getElementById('singleResults').style.display = 'none';
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('singleResults').style.display = 'none';
            document.getElementById('projectResults').style.display = 'none';
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtn').innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-right: 10px;"></div>Scanning...';
            
            try {
                if (scanType === 'professional' && serverAvailable) {
                    debugLog('Using Bandit + Semgrep backend scan', 'info');
                    await performProfessionalScan(code);
                } else {
                    debugLog('Using Pyodide AST analysis', 'info');
                    await performDeepScan(code);
                }
                
                displayResults();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('singleResults').style.display = 'block';
            } catch (error) {
                debugLog(`Scan error: ${error.message}`, 'error');
                console.error('Scan error:', error);
                alert('Scanning failed: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            } finally {
                resetScanButton();
            }
        }
        
        async function scanProject() {
            const folderInput = document.getElementById('folderInput');
            if (!folderInput.files || folderInput.files.length === 0) {
                alert('Please select a project folder first!');
                return;
            }
            
            const scanType = document.querySelector('input[name="scanType"]:checked').value;
            debugLog(`Starting project scan with type: ${scanType}`, 'info');
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('projectResults').style.display = 'none';
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtn').innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; margin-right: 10px;"></div>Scanning Project...';
            
            try {
                if (scanType === 'professional' && serverAvailable) {
                    debugLog('Using professional backend scan', 'info');
                    await performProjectScan(folderInput.files);
                } else {
                    debugLog('Using browser-based project scan', 'info');
                    await performBrowserProjectScan(folderInput.files);
                }
                
                debugLog('Project scan completed successfully', 'success');
                displayProjectResults();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('projectResults').style.display = 'block';
            } catch (error) {
                debugLog(`Project scan error: ${error.message}`, 'error');
                console.error('Project scan error:', error);
                alert('Project scanning failed: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            } finally {
                resetScanButton();
            }
        }
        
        function resetScanButton() {
            document.getElementById('scanBtn').disabled = false;
            document.getElementById('scanBtn').innerHTML = '<i data-lucide="scan" style="width: 18px; height: 18px; margin-right: 8px;"></i> Scan for Vulnerabilities';
            lucide.createIcons();
        }
        
        async function performDeepScan(code) {
            const settings = getSettings();
            const totalLines = code.split('\n').length;
            const showProgress = totalLines > settings.progressThreshold;
            
            if (showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                updateProgress(10, 'Initializing Python environment...');
            }
            
            // Initialize Pyodide if not already done
            await initPyodide();
            
            if (showProgress) {
                updateProgress(30, 'Parsing code structure...');
            }
            
            // Pass code to Python scanner
            pyodide.globals.set("code_to_scan", code);
            
            if (showProgress) {
                updateProgress(50, 'Running AST security analysis...');
            }
            
            await pyodide.runPython(`
result = scanner.scan_code(code_to_scan)
            `);
            
            if (showProgress) {
                updateProgress(70, 'Running regex pattern matching...');
            }
            
            // Get results from Python
            const pythonResults = pyodide.globals.get('result').toJs({dict_converter: Object.fromEntries});
            
            // Convert Python findings to our format and merge with regex findings
            const astFindings = pythonResults.findings.map(finding => ({
                category: finding.category,
                name: finding.name,
                severity: finding.severity,
                line: finding.line,
                code: finding.code,
                description: finding.description,
                source: 'AST'
            }));
            
            // Only use AST findings for cleaner results
            const uniqueFindings = astFindings;
            
            if (showProgress) {
                updateProgress(90, 'Calculating security score...');
            }
            
            // Calculate enhanced security score
            const highCount = uniqueFindings.filter(f => f.severity === 'high').length;
            const mediumCount = uniqueFindings.filter(f => f.severity === 'medium').length;
            const lowCount = uniqueFindings.filter(f => f.severity === 'low').length;
            
            const weightedIssues = (highCount * 3) + (mediumCount * 2) + (lowCount * 1);
            const score = Math.max(0, Math.min(100, 100 - (weightedIssues * 8))); // Slightly stricter scoring for deep scan
            
            if (showProgress) {
                updateProgress(100, 'Analysis complete!');
                // Hide progress after a brief delay
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                }, 500);
            }
            
            scanResults = {
                findings: uniqueFindings,
                score: Math.round(score),
                counts: { high: highCount, medium: mediumCount, low: lowCount },
                totalLines: pythonResults.total_lines,
                scanType: 'deep'
            };
        }
        
        async function performProfessionalScan(code) {
            const settings = getSettings();
            const totalLines = code.split('\n').length;
            const showProgress = totalLines > settings.progressThreshold;
            
            if (showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                updateProgress(10, 'Connecting to security backend...');
            }
            
            try {
                const response = await fetch(`${API_BASE}/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        tools: ['bandit', 'semgrep']
                    })
                });
                
                if (showProgress) {
                    updateProgress(50, 'Running Bandit and Semgrep analysis...');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (showProgress) {
                    updateProgress(80, 'Processing results...');
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'Scan failed');
                }
                
                // Convert backend results to our format
                const findings = result.results.findings.map(finding => ({
                    category: finding.category,
                    name: finding.name,
                    severity: finding.severity,
                    line: finding.line,
                    code: finding.code,
                    description: finding.description,
                    source: finding.tool.toUpperCase(),
                    confidence: finding.confidence
                }));
                
                if (showProgress) {
                    updateProgress(100, 'Analysis complete!');
                    setTimeout(() => {
                        document.getElementById('progressContainer').style.display = 'none';
                    }, 500);
                }
                
                scanResults = {
                    findings: findings,
                    score: result.results.security_score,
                    counts: result.results.summary,
                    totalLines: result.results.total_lines,
                    scanType: 'professional',
                    toolResults: result.results.tool_results
                };
                
            } catch (error) {
                console.error('Professional scan failed:', error);
                // Fallback to deep scan
                alert('Backend unavailable, falling back to browser-based deep scan...');
                await performDeepScan(code);
            }
        }
        
                async function performProjectScan(files) {
            const formData = new FormData();
            let fileCount = 0;

            const filteredFiles = Array.from(files).filter(file => !shouldIgnoreFile(file.webkitRelativePath || file.name));
            
            filteredFiles.forEach(file => {
                if (file.name.endsWith('.py') || file.name.endsWith('.js') || file.name.endsWith('.php') ||
                    file.name.endsWith('.java') || file.name.endsWith('.rb') || file.name.endsWith('.go') ||
                    file.name.endsWith('.cpp') || file.name.endsWith('.c') || file.name.endsWith('.cs')) {
                    formData.append('folder', file);
                    fileCount++;
                }
            });

            formData.append('tools', 'bandit,semgrep');
            
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, 'Starting project scan...');

            projectResults = {
                files: {},
                summary: { high: 0, medium: 0, low: 0 },
                total_files: 0,
                total_lines: 0,
                security_score: 0
            };

            try {
                const response = await fetch(`${API_BASE}/scan-folder`, {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        debugLog('Stream finished.', 'success');
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    debugLog(`Received chunk: ${buffer}`, 'info');

                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep the last, possibly incomplete line

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            try {
                                const data = JSON.parse(line.substring(5));
                                debugLog(`Parsed data: ${JSON.stringify(data)}`, 'info');

                                if (data.type === 'status') {
                                    projectResults.total_files = data.total_files;
                                    updateProgress(0, `Scanning ${data.total_files} files...`);
                                } else if (data.type === 'finding') {
                                    projectResults.files[data.file] = data.results;
                                    projectResults.total_lines += data.results.total_lines;
                                    for (const severity in data.results.summary) {
                                        projectResults.summary[severity] += data.results.summary[severity];
                                    }
                                    updateProgress(data.progress, `Scanned ${data.file}`);
                                } else if (data.type === 'error') {
                                    debugLog(`Error scanning ${data.file}: ${data.error}`, 'error');
                                }
                                 else if (data.type === 'done') {
                                    updateProgress(100, 'Scan complete!');
                                    const totalWeightedIssues = (projectResults.summary.high * 3) + (projectResults.summary.medium * 2) + (projectResults.summary.low * 1);
                                    projectResults.security_score = Math.max(0, Math.min(100, 100 - (totalWeightedIssues * 5)));
                                    return;
                                }
                            } catch (e) {
                                debugLog(`Error parsing JSON: ${e}`, 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                debugLog(`Fetch error: ${error}`, 'error');
            }
        }
        
        async function performBrowserProjectScan(files) {
            console.log('Starting browser project scan with', files.length, 'files');
            
            projectResults = {
                files: {},
                summary: { high: 0, medium: 0, low: 0 },
                total_files: 0,
                total_lines: 0,
                security_score: 0,
                scanType: 'browser'
            };
            
            // Filter out ignored directories/files first, then get code files
            const filteredFiles = Array.from(files).filter(file => !shouldIgnoreFile(file.webkitRelativePath || file.name));
            const codeFiles = filteredFiles.filter(file => 
                file.name.endsWith('.py') || file.name.endsWith('.js') || file.name.endsWith('.php') ||
                file.name.endsWith('.java') || file.name.endsWith('.rb') || file.name.endsWith('.go') ||
                file.name.endsWith('.cpp') || file.name.endsWith('.c') || file.name.endsWith('.cs')
            );
            
            const ignoredCount = files.length - filteredFiles.length;
            console.log(`Filtered ${files.length} total files to ${filteredFiles.length} (ignored ${ignoredCount})`);
            console.log('Found', codeFiles.length, 'code files to scan');
            if (ignoredCount > 0) {
                debugLog(`Ignored ${ignoredCount} files from directories like .venv, node_modules, etc.`, 'info');
            }
            
            let totalWeightedIssues = 0;
            projectResults.total_files = codeFiles.length;
            
            for (let i = 0; i < codeFiles.length; i++) {
                const file = codeFiles[i];
                const progressPercent = 20 + (i / codeFiles.length) * 60;
                updateProgress(progressPercent, `Scanning ${file.name}... (${i + 1}/${codeFiles.length})`);
                
                console.log(`Scanning file ${i + 1}/${codeFiles.length}: ${file.name}`);
                
                try {
                    const code = await readFileAsText(file);
                    console.log(`Read ${code.length} characters from ${file.name}`);
                    
                    const scanType = document.querySelector('input[name="scanType"]:checked').value;
                    
                    let fileResults;
                    if (scanType === 'deep') {
                        // Use AST scanning for this file
                        console.log(`Running deep scan on ${file.name}`);
                        await initPyodide();
                        pyodide.globals.set("code_to_scan", code);
                        await pyodide.runPython(`result = scanner.scan_code(code_to_scan)`);
                        const pythonResults = pyodide.globals.get('result').toJs({dict_converter: Object.fromEntries});
                        fileResults = {
                            findings: pythonResults.findings,
                            summary: { high: 0, medium: 0, low: 0 },
                            total_lines: pythonResults.total_lines
                        };
                        console.log(`Deep scan found ${pythonResults.findings.length} findings in ${file.name}`);
                    } else {
                        // Fallback to deep scan for browser mode
                        console.log(`Running fallback AST scan on ${file.name}`);
                        await initPyodide();
                        pyodide.globals.set("code_to_scan", code);
                        await pyodide.runPython(`result = scanner.scan_code(code_to_scan)`);
                        const pythonResults = pyodide.globals.get('result').toJs({dict_converter: Object.fromEntries});
                        fileResults = {
                            findings: pythonResults.findings,
                            summary: { high: 0, medium: 0, low: 0 },
                            total_lines: pythonResults.total_lines
                        };
                        console.log(`AST scan found ${pythonResults.findings.length} findings in ${file.name}`);
                    }
                    
                    // Calculate summary for this file
                    fileResults.findings.forEach(f => {
                        if (fileResults.summary[f.severity] !== undefined) {
                            fileResults.summary[f.severity]++;
                        }
                    });
                    
                    projectResults.files[file.name] = fileResults;
                    projectResults.total_lines += fileResults.total_lines;
                    
                    // Aggregate to project summary
                    Object.keys(fileResults.summary).forEach(severity => {
                        projectResults.summary[severity] += fileResults.summary[severity];
                    });
                    
                    // Calculate weighted issues
                    const fileWeighted = (fileResults.summary.high * 3) + 
                                       (fileResults.summary.medium * 2) + 
                                       (fileResults.summary.low * 1);
                    totalWeightedIssues += fileWeighted;
                    
                } catch (error) {
                    console.error(`Error scanning ${file.name}:`, error);
                    // Add more detailed error logging
                    console.error('Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    projectResults.files[file.name] = {
                        error: error.message,
                        findings: [],
                        summary: { high: 0, medium: 0, low: 0 }
                    };
                    
                    // Update progress even on error to prevent hanging
                    updateProgress(20 + ((i + 1) / codeFiles.length) * 60, `Error scanning ${file.name}, continuing...`);
                }
                
                // Add a small delay to prevent browser freezing
                if (i % 10 === 0 && i > 0) {
                    console.log(`Processed ${i} files, taking a brief pause...`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Calculate overall project score
            projectResults.security_score = Math.max(0, Math.min(100, 100 - (totalWeightedIssues * 5)));
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        function updateProgress(percentage, message) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
            document.getElementById('loadingText').textContent = message;
        }
        
        // Server connectivity check
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const health = await response.json();
                    serverAvailable = true;
                    updateServerStatus(true, health.tools);
                } else {
                    serverAvailable = false;
                    updateServerStatus(false);
                }
            } catch (error) {
                serverAvailable = false;
                updateServerStatus(false);
            }
        }
        
        function updateServerStatus(available, tools = {}) {
            const statusDiv = document.getElementById('serverStatus');
            const professionalScan = document.getElementById('professionalScan');
            
            if (available) {
                const toolCount = Object.values(tools).filter(t => t.available).length;
                statusDiv.innerHTML = `<span style="color: #48bb78;">🟢 Backend Connected</span> - ${toolCount} security tools available`;
                professionalScan.disabled = false;
                professionalScan.parentElement.style.opacity = '1';
            } else {
                statusDiv.innerHTML = `<span style="color: #f56565;">🔴 Backend Offline</span> - Professional scan unavailable`;
                professionalScan.disabled = true;
                professionalScan.parentElement.style.opacity = '0.5';
                
                // Auto-switch to AST scan if professional was selected
                if (document.querySelector('input[name="scanType"]:checked').value === 'professional') {
                    document.querySelector('input[name="scanType"][value="deep"]').checked = true;
                }
            }
        }
        
        function deduplicateFindings(findings) {
            const seen = new Set();
            return findings.filter(finding => {
                const key = `${finding.line}-${finding.name}-${finding.severity}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }
        
        
        
        function getDescription(name) {
            const descriptions = {
                "Hardcoded Password": "Passwords should be stored in environment variables or secure vaults",
                "API Key Exposure": "API keys should be stored securely and never committed to code",
                "Secret Key": "Secret keys should be externalized and encrypted at rest",
                "Token Exposure": "Tokens should be stored securely and have proper expiration",
                "Private Key": "Private keys should never be hardcoded in source code",
                "SQL Injection Risk": "Use parameterized queries to prevent SQL injection",
                "Dynamic SQL Execution": "Avoid dynamic SQL construction with user input",
                "XSS Risk (innerHTML)": "Sanitize input before inserting into DOM",
                "XSS Risk (document.write)": "Avoid document.write with dynamic content",
                "Code Injection (eval)": "Never use eval() with user-controlled input",
                "Weak Hash Algorithm (MD5)": "MD5 is cryptographically broken - use SHA-256 or stronger",
                "Weak Hash Algorithm (SHA1)": "SHA-1 has known collision vulnerabilities - use SHA-256 or stronger", 
                "Weak Encryption (DES)": "DES has a small key size and is easily broken - use AES-256",
                "Weak Encryption (RC4)": "RC4 has known vulnerabilities - use AES or ChaCha20",
                "Weak Random Generator": "Use cryptographically secure random generators for security purposes",
                "Path Traversal Risk": "Validate and sanitize file paths to prevent directory traversal",
                "Temp Directory Usage": "Be cautious with temporary file operations and permissions",
                "Command Injection Risk": "Avoid shell=True in subprocess calls - use array arguments",
                "OS Command Execution": "Use subprocess module instead of os.system/popen"
            };
            return descriptions[name] || "Security issue detected";
        }
        
        function displayResults() {
            const settings = getSettings();
            
            // Filter findings based on settings
            let displayFindings = scanResults.findings;
            if (!settings.includeLowSeverity) {
                displayFindings = scanResults.findings.filter(f => f.severity !== 'low');
            }
            
            // Update metrics
            document.getElementById('securityScore').textContent = scanResults.score;
            document.getElementById('issueCount').textContent = displayFindings.length;
            
            // Update scan type badge
            const scanTypeBadge = document.getElementById('scanTypeBadge');
            const badgeText = {
                'deep': 'PYODIDE', 
                'professional': 'BANDIT + SEMGREP'
            };
            scanTypeBadge.textContent = badgeText[scanResults.scanType] || 'PYODIDE';
            
            // Color code security score
            const scoreElement = document.getElementById('securityScore');
            scoreElement.className = 'metric-value ' + 
                (scanResults.score >= 80 ? 'score-high' : 
                 scanResults.score >= 60 ? 'score-medium' : 'score-low');
            
            // Create vulnerability chart
            createChart(displayFindings);
            
            // Display findings
            const findingsList = document.getElementById('findingsList');
            findingsList.innerHTML = '';
            
            if (displayFindings.length === 0) {
                const message = settings.includeLowSeverity ? 
                    '🎉 No security issues found!' : 
                    '🎉 No high/medium severity issues found!';
                findingsList.innerHTML = `<p style="text-align: center; color: #48bb78; font-size: 1.2rem;">${message}</p>`;
            } else {
                displayFindings.forEach(finding => {
                    const div = document.createElement('div');
                    div.className = `finding ${finding.severity}`;
                    const toolTag = finding.source ? `<span class="finding-tool-tag">${finding.source.toUpperCase()}</span>` : `<span class="finding-tool-tag">PYODIDE</span>`;
                    const severityIcon = {
                        'high': '<i data-lucide="alert-triangle" style="width: 16px; height: 16px; color: #dc2626;"></i>',
                        'medium': '<i data-lucide="alert-circle" style="width: 16px; height: 16px; color: #f59e0b;"></i>',
                        'low': '<i data-lucide="info" style="width: 16px; height: 16px; color: #6b7280;"></i>'
                    };
                    
                    div.innerHTML = `
                        <div class="finding-header">
                            <div class="finding-title">
                                ${severityIcon[finding.severity] || ''} 
                                ${finding.name}
                            </div>
                            <div class="finding-meta">
                                ${toolTag}
                                <div class="finding-line-number">Line ${finding.line}</div>
                            </div>
                        </div>
                        <div class="finding-description">${finding.description}</div>
                        <div class="finding-code">
                            <div class="finding-code-header">
                                <i data-lucide="code" style="width: 14px; height: 14px;"></i> 
                                Code Context
                            </div>
                            <pre><code>${finding.code}</code></pre>
                        </div>
                    `;
                    
                    // Re-initialize icons for this finding
                    if (typeof lucide !== 'undefined') {
                        const icons = div.querySelectorAll('[data-lucide]');
                        icons.forEach(icon => lucide.createIcons({ icons: { [icon.getAttribute('data-lucide')]: lucide.icons[icon.getAttribute('data-lucide')] } }));
                    }
                    findingsList.appendChild(div);
                });
            }
        }
        
        function displayProjectResults() {
            // Update project metrics
            document.getElementById('projectScore').textContent = projectResults.security_score;
            document.getElementById('projectFiles').textContent = projectResults.total_files;
            document.getElementById('projectIssues').textContent = 
                projectResults.summary.high + projectResults.summary.medium + projectResults.summary.low;
            document.getElementById('projectLines').textContent = projectResults.total_lines;
            
            // Color code project score
            const scoreElement = document.getElementById('projectScore');
            scoreElement.className = 'metric-value ' + 
                (projectResults.security_score >= 80 ? 'score-high' : 
                 projectResults.security_score >= 60 ? 'score-medium' : 'score-low');
            
            // Populate file list
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Object.entries(projectResults.files).forEach(([filename, fileData]) => {
                if (fileData.error) {
                    return; // Skip files with errors for now
                }
                
                const totalIssues = fileData.summary.high + fileData.summary.medium + fileData.summary.low;
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.onclick = () => selectFile(filename);
                
                const statusBadges = [];
                if (fileData.summary.high > 0) {
                    statusBadges.push(`<span class="severity-badge high">${fileData.summary.high}</span>`);
                }
                if (fileData.summary.medium > 0) {
                    statusBadges.push(`<span class="severity-badge medium">${fileData.summary.medium}</span>`);
                }
                if (fileData.summary.low > 0) {
                    statusBadges.push(`<span class="severity-badge low">${fileData.summary.low}</span>`);
                }
                
                if (statusBadges.length === 0) {
                    statusBadges.push(`<span class="severity-badge">✅</span>`);
                }
                
                fileItem.innerHTML = `
                    <div class="file-name">${filename}</div>
                    <div class="file-status">${statusBadges.join('')}</div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            // Auto-select first file with issues
            const filesWithIssues = Object.keys(projectResults.files).filter(filename => {
                const fileData = projectResults.files[filename];
                return !fileData.error && fileData.findings && fileData.findings.length > 0;
            });
            
            if (filesWithIssues.length > 0) {
                selectFile(filesWithIssues[0]);
            }
        }
        
        function selectFile(filename) {
            selectedFile = filename;
            const fileData = projectResults.files[filename];
            
            // Update selected file display
            document.getElementById('selectedFileName').textContent = filename;
            
            // Highlight selected file in list
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
                if (item.querySelector('.file-name').textContent === filename) {
                    item.classList.add('selected');
                }
            });
            
            // Display file findings
            const findingsDiv = document.getElementById('selectedFileFindings');
            findingsDiv.innerHTML = '';
            
            if (fileData.error) {
                findingsDiv.innerHTML = `<p style="color: #f56565;">❌ Error scanning file: ${fileData.error}</p>`;
                return;
            }
            
            if (!fileData.findings || fileData.findings.length === 0) {
                findingsDiv.innerHTML = `<p style="text-align: center; color: #48bb78; font-size: 1.2rem;">🎉 No security issues found in this file!</p>`;
                return;
            }
            
            fileData.findings.forEach(finding => {
                const div = document.createElement('div');
                div.className = `finding ${finding.severity}`;
                const toolTag = finding.source ? `<span class="finding-tool-tag">${finding.source.toUpperCase()}</span>` : `<span class="finding-tool-tag">PYODIDE</span>`;
                const severityIcon = {
                    'high': '<i data-lucide="alert-triangle" style="width: 16px; height: 16px; color: #dc2626;"></i>',
                    'medium': '<i data-lucide="alert-circle" style="width: 16px; height: 16px; color: #f59e0b;"></i>',
                    'low': '<i data-lucide="info" style="width: 16px; height: 16px; color: #6b7280;"></i>'
                };
                
                div.innerHTML = `
                    <div class="finding-header">
                        <div class="finding-title">
                            ${severityIcon[finding.severity] || ''} 
                            ${finding.name}
                        </div>
                        <div class="finding-meta">
                            ${toolTag}
                            <div class="finding-line-number">Line ${finding.line}</div>
                        </div>
                    </div>
                    <div class="finding-description">${finding.description}</div>
                    <div class="finding-code">
                        <div class="finding-code-header">
                            <i data-lucide="code" style="width: 14px; height: 14px;"></i> 
                            Code Context
                        </div>
                        <pre><code>${finding.code}</code></pre>
                    </div>
                `;
                
                // Re-initialize icons for this finding
                if (typeof lucide !== 'undefined') {
                    const icons = div.querySelectorAll('[data-lucide]');
                    icons.forEach(icon => lucide.createIcons({ icons: { [icon.getAttribute('data-lucide')]: lucide.icons[icon.getAttribute('data-lucide')] } }));
                }
                findingsDiv.appendChild(div);
            });
        }
        
        function createChart(displayFindings = null) {
            const ctx = document.getElementById('vulnerabilityChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // Use filtered findings if provided, otherwise use all findings
            const findings = displayFindings || scanResults.findings;
            const highCount = findings.filter(f => f.severity === 'high').length;
            const mediumCount = findings.filter(f => f.severity === 'medium').length;
            const lowCount = findings.filter(f => f.severity === 'low').length;
            
            const data = {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Vulnerabilities by Severity',
                    data: [highCount, mediumCount, lowCount],
                    backgroundColor: ['#f56565', '#ed8936', '#48bb78'],
                    borderWidth: 0
                }]
            };
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Vulnerability Distribution',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function exportReport(format) {
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (format === 'json') {
                const report = {
                    timestamp: new Date().toISOString(),
                    scanType: scanResults.scanType || 'quick',
                    score: scanResults.score,
                    summary: scanResults.counts,
                    totalLines: scanResults.totalLines,
                    findings: scanResults.findings,
                    metadata: {
                        tool: 'DevSec Dash',
                        version: '2.0'
                    }
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                downloadFile(blob, `security-report-${timestamp}.json`);
            } else if (format === 'markdown') {
                let markdown = `# Security Scan Report\n\n`;
                markdown += `**Date:** ${new Date().toLocaleDateString()}\n`;
                const scanTypeText = {
                    'quick': '⚡ Quick Scan (Regex)',
                    'deep': '🔬 Deep Scan (AST Analysis)',
                    'professional': '🛡️ Professional Scan (Bandit + Semgrep)'
                };
                markdown += `**Scan Type:** ${scanTypeText[scanResults.scanType] || '⚡ Quick Scan (Regex)'}\n`;
                markdown += `**Security Score:** ${scanResults.score}/100\n`;
                markdown += `**Total Issues:** ${scanResults.findings.length}\n`;
                markdown += `**Lines Analyzed:** ${scanResults.totalLines}\n\n`;
                
                markdown += `## Summary\n\n`;
                markdown += `- High Severity: ${scanResults.counts.high}\n`;
                markdown += `- Medium Severity: ${scanResults.counts.medium}\n`;
                markdown += `- Low Severity: ${scanResults.counts.low}\n\n`;
                
                if (scanResults.findings.length > 0) {
                    markdown += `## Findings\n\n`;
                    scanResults.findings.forEach((finding, index) => {
                        const sourceInfo = finding.source ? ` (${finding.source})` : '';
                        markdown += `### ${index + 1}. ${finding.name}${sourceInfo} (${finding.severity.toUpperCase()})\n\n`;
                        markdown += `**Line ${finding.line}:** \`${finding.code}\`\n\n`;
                        markdown += `${finding.description}\n\n`;
                    });
                }
                
                markdown += `---\n*Generated by DevSec Dash v2.0 - Local Security Scanner*\n`;
                
                const blob = new Blob([markdown], { type: 'text/markdown' });
                downloadFile(blob, `security-report-${timestamp}.md`);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title and header
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('DevSec Dash - Security Report', 20, 25);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 35);
                const pdfScanTypeText = {
                    'quick': 'Quick Scan (Regex)',
                    'deep': 'Deep Scan (AST Analysis)',
                    'professional': 'Professional Scan (Bandit + Semgrep)'
                };
                doc.text(`Scan Type: ${pdfScanTypeText[scanResults.scanType] || 'Quick Scan (Regex)'}`, 20, 42);
                doc.text(`Security Score: ${scanResults.score}/100`, 20, 49);
                doc.text(`Total Issues: ${scanResults.findings.length}`, 20, 56);
                doc.text(`Lines Analyzed: ${scanResults.totalLines}`, 20, 63);
                
                // Summary section
                doc.setFont('helvetica', 'bold');
                doc.text('Summary', 20, 78);
                doc.setFont('helvetica', 'normal');
                doc.text(`High Severity: ${scanResults.counts.high}`, 30, 88);
                doc.text(`Medium Severity: ${scanResults.counts.medium}`, 30, 95);
                doc.text(`Low Severity: ${scanResults.counts.low}`, 30, 102);
                
                let yPos = 120;
                
                if (scanResults.findings.length > 0) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Findings', 20, yPos);
                    yPos += 15;
                    
                    scanResults.findings.forEach((finding, index) => {
                        if (yPos > 270) { // Start new page if needed
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${finding.name} (${finding.severity.toUpperCase()})`, 20, yPos);
                        yPos += 7;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Line ${finding.line}: ${finding.code.substring(0, 60)}${finding.code.length > 60 ? '...' : ''}`, 30, yPos);
                        yPos += 7;
                        
                        // Wrap description text
                        const description = finding.description;
                        const lines = doc.splitTextToSize(description, 160);
                        doc.text(lines, 30, yPos);
                        yPos += lines.length * 7 + 5;
                    });
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Generated by DevSec Dash v2.0 - Local Security Scanner', 20, 285);
                }
                
                doc.save(`security-report-${timestamp}.pdf`);
            }
        }
        
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Settings management
        function openSettings() {
            loadSettings();
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function loadSettings() {
            const settings = getSettings();
            document.getElementById('defaultScanType').value = settings.defaultScanType;
            document.getElementById('autoClearResults').checked = settings.autoClearResults;
            document.getElementById('progressThreshold').value = settings.progressThreshold;
            document.getElementById('includeLowSeverity').checked = settings.includeLowSeverity;
        }
        
        function saveSettings() {
            const settings = {
                defaultScanType: document.getElementById('defaultScanType').value,
                autoClearResults: document.getElementById('autoClearResults').checked,
                progressThreshold: parseInt(document.getElementById('progressThreshold').value),
                includeLowSeverity: document.getElementById('includeLowSeverity').checked
            };
            
            localStorage.setItem('devSecDashSettings', JSON.stringify(settings));
            applySettings(settings);
            closeSettings();
            
            // Show confirmation
            const originalText = document.querySelector('.settings-btn').textContent;
            document.querySelector('.settings-btn').textContent = '✅';
            setTimeout(() => {
                document.querySelector('.settings-btn').textContent = originalText;
            }, 1000);
        }
        
        function resetSettings() {
            localStorage.removeItem('devSecDashSettings');
            loadSettings();
        }
        
        function getSettings() {
            const defaultSettings = {
                defaultScanType: 'deep',
                autoClearResults: false,
                progressThreshold: 50,
                includeLowSeverity: true
            };
            
            const saved = localStorage.getItem('devSecDashSettings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
        }
        
        function applySettings(settings) {
            // Apply default scan type
            document.querySelector(`input[name="scanType"][value="${settings.defaultScanType}"]`).checked = true;
        }
        
        // Demo code loader
        function loadDemo() {
            const demoCode = `import os
import hashlib
import subprocess

# Security issues for demo - DevSec Dash Test
password = "admin123"  # Hardcoded password
api_key = "sk-abc123xyz"  # API key exposure  
secret_key = "my-secret-key-123"  # Secret key

def login(user_input):
    # SQL injection vulnerability
    query = "SELECT * FROM users WHERE name='" + user_input + "'"
    
    # Dangerous eval usage
    eval("print('hello')")
    
    # Dangerous exec usage
    exec(user_input)
    
    # Weak hashing
    hash = hashlib.md5(password.encode()).hexdigest()
    weak_hash = hashlib.sha1(password.encode()).hexdigest()
    
    # Path traversal risk
    file_path = "../../../etc/passwd"
    
    return execute_query(query)

def process_data(user_command):
    # Command injection risk
    subprocess.call(user_command, shell=True)
    
    # More string concatenation risks
    sql = "INSERT INTO logs VALUES ('" + user_command + "')"
    
def render_page(content):
    # XSS vulnerability
    return "<div>" + content + "</div>"

# Test both scanners with this rich example
`;
            document.getElementById('codeInput').value = demoCode;
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Load and apply saved settings
            const settings = getSettings();
            applySettings(settings);
            
            // Check server status on load
            checkServerStatus();
            
            // Check server status periodically
            setInterval(checkServerStatus, 30000); // Every 30 seconds
            
            // Add demo button
            const demoBtn = document.createElement('button');
            demoBtn.innerHTML = '<i data-lucide="target"></i> Try Demo Code';
            demoBtn.className = 'upload-btn';
            demoBtn.style.background = '#dc2626';
            demoBtn.onclick = loadDemo;
            document.querySelector('.file-upload').insertBefore(demoBtn, document.querySelector('textarea'));
            
            // Re-initialize icons for dynamically added elements
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Close settings modal when clicking outside
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });
        });
    </script>
</body>
</html>